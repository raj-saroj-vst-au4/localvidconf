# =============================================================================
# Nginx Reverse Proxy Configuration (internal server)
# Routes /meet/* to Next.js web app, /media/* to mediasoup media server
# Designed to sit behind an existing public-facing reverse proxy
# =============================================================================

# Connection upgrade map for WebSocket support
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Preserve the original protocol set by the upstream public proxy.
# When the public server terminates TLS, it sets X-Forwarded-Proto: https.
# Without this passthrough, NextAuth would see http:// and generate wrong
# callback/redirect URLs.
map $http_x_forwarded_proto $real_proto {
    default $scheme;
    "http"  "http";
    "https" "https";
}

server {
    listen 80;
    server_name _;

    # --- Trust real client IP forwarded by the public proxy ---
    # Uncomment and set to your public server's IP so logs show real client IPs.
    # set_real_ip_from  PUBLIC_SERVER_IP;
    # real_ip_header    X-Forwarded-For;
    # real_ip_recursive on;

    # --- Security Headers ---
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # --- Root redirect to /meet ---
    location = / {
        return 302 /meet;
    }

    # --- Next.js Web App ---
    # Next.js runs with basePath: '/meet', so pass the full path through
    location /meet {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_proto;
        proxy_read_timeout 86400s;
    }

    # --- Media Server Socket.IO ---
    # Client connects with path: '/media/socket.io/'
    # Nginx strips /media prefix so media server sees /socket.io/
    location /media/socket.io/ {
        proxy_pass http://127.0.0.1:4000/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_proto;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # --- Media Server HTTP endpoints (health, turn-credentials) ---
    # Strips /media prefix: /media/health â†’ /health
    location /media/ {
        proxy_pass http://127.0.0.1:4000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $real_proto;
    }

    # --- Request size limit ---
    client_max_body_size 10m;
}
